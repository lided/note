import{_ as a,c as e,o as i,ag as t}from"./chunks/framework.DPDPlp3K.js";const u=JSON.parse('{"title":"","description":"","frontmatter":{},"headers":[],"relativePath":"database/redis/cluster.md","filePath":"database/redis/cluster.md"}'),l={name:"database/redis/cluster.md"};function p(n,s,c,d,o,r){return i(),e("div",null,s[0]||(s[0]=[t(`<h2 id="介绍" tabindex="-1">介绍 <a class="header-anchor" href="#介绍" aria-label="Permalink to &quot;介绍&quot;">​</a></h2><ol><li>redis集群支持多个master</li><li>自带sentinel的故障转移机制,无需使用哨兵</li><li>slots槽位最多16384,服务器节点最大建议1000个左右</li><li>客户端要连接cluster集群不会连接其中的每一个redis服务器</li></ol><h2 id="哈希槽分区算法" tabindex="-1">哈希槽分区算法 <a class="header-anchor" href="#哈希槽分区算法" aria-label="Permalink to &quot;哈希槽分区算法&quot;">​</a></h2><p>在数据和节点之间加入一层,称为哈希槽slot</p><h3 id="为什么是16384-2-14" tabindex="-1">为什么是16384(2^14)? <a class="header-anchor" href="#为什么是16384-2-14" aria-label="Permalink to &quot;为什么是16384(2^14)?&quot;">​</a></h3><ol><li>每秒钟redis都要发送ping消息心跳包,如果是2^16(65536),消息头需要slots/8b也就是8kb的大小,浪费带宽</li><li>集群节点数不建议超过1000,如果太多消息体数据太多也会导致网络拥堵。对于1000个节点以内的cluster16384个槽够用了</li><li>每一个节点所负责的哈希槽是通过bitmap保存的。如果槽位使用率(slot/Node)很高，即槽位太多节点太少，就会导致bitmap压缩率很低。</li><li>总体而言，16384个哈希槽是在平衡分布、简便性和未来扩展性之间做出的妥协的结果。(说人话就是16384最适合redis的性能)</li></ol><h2 id="开始3主3从搭建" tabindex="-1">开始3主3从搭建 <a class="header-anchor" href="#开始3主3从搭建" aria-label="Permalink to &quot;开始3主3从搭建&quot;">​</a></h2><p>为所有redis节点新建一个cluster配置文件并在之前的基础上新增如下配置</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>cluster-enabled yes</span></span>
<span class="line"><span>cluster-config-file node-6379.conf</span></span>
<span class="line"><span>cluster-node-timeout 15000</span></span></code></pre></div><p>为集群配置主从关系 --cluster-replicas 1 中的1表示每一台主机有1个slave 后面将需要添加集群的机器加入</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>redis-cli --cluster create --cluster-replicas 1 [ip:port]+</span></span></code></pre></div><p>查看cluster信息</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">redis-cli</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --cluster</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> check</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">cluster_i</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">p</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span></span></code></pre></div><p>连接集群内任意一台redis查看集群节点信息</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>cluster nodes</span></span>
<span class="line"><span>cluster info</span></span></code></pre></div><h2 id="使用" tabindex="-1">使用 <a class="header-anchor" href="#使用" aria-label="Permalink to &quot;使用&quot;">​</a></h2><p>在登录命令后加<code>-c</code> 选项告诉 <code>redis-cli</code> 在集群模式下运行。</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>redis-cli -a &lt;pwd&gt; -p 6379 -c</span></span></code></pre></div><p>查看key属于在那个槽位</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>cluster keyslot &lt;key&gt;</span></span></code></pre></div><p>查看某一个slot中是否有数据</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>cluster countkeysinslot</span></span></code></pre></div><p>将slave自己和对应master交换(在slave节点上操作)</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>cluster failover</span></span></code></pre></div><h2 id="新增节点" tabindex="-1">新增节点 <a class="header-anchor" href="#新增节点" aria-label="Permalink to &quot;新增节点&quot;">​</a></h2><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span># cluster_ip为集群任意一个</span></span>
<span class="line"><span>redis-cli -a lide --cluster add-node &lt;new_ip&gt; &lt;cluster_ip&gt;</span></span></code></pre></div><p>查看槽位分配信息</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>redis-cli -a lide --cluster check &lt;cluster_ip&gt;</span></span></code></pre></div><p>重新分配槽位</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>redis-cli -a lide --cluster reshard &lt;cluster_ip&gt;</span></span></code></pre></div><p>然后按照提示输入信息</p><ol><li>要为新的node迁移多少个slot</li><li>要给哪个节点迁移(id)</li><li>从哪些节点迁移(all即可)</li></ol><p>为新的master分配从节点</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>redis-cli  -a lide --cluster add-node &lt;new_slave_ip&gt; &lt;new_master_ip&gt; --cluster-slave --cluster-master-id &lt;master_id&gt;</span></span></code></pre></div><p>从集群中删除某一节点(如果要删除master得先把slots移出去)</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>redis-cli -a lide --cluster del-node &lt;cluster_IP&gt; &lt;del_id&gt;</span></span></code></pre></div>`,36)]))}const g=a(l,[["render",p]]);export{u as __pageData,g as default};
