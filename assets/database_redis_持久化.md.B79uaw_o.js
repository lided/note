import{_ as s,c as e,o as i,ag as n}from"./chunks/framework.DPDPlp3K.js";const b=JSON.parse('{"title":"RDB","description":"","frontmatter":{},"headers":[],"relativePath":"database/redis/持久化.md","filePath":"database/redis/持久化.md"}'),t={name:"database/redis/持久化.md"};function p(l,a,d,o,h,r){return i(),e("div",null,a[0]||(a[0]=[n(`<h1 id="rdb" tabindex="-1">RDB <a class="header-anchor" href="#rdb" aria-label="Permalink to &quot;RDB&quot;">​</a></h1><h2 id="配置" tabindex="-1">配置 <a class="header-anchor" href="#配置" aria-label="Permalink to &quot;配置&quot;">​</a></h2><p>修改持久化数据文件默认路径</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>dir ./</span></span></code></pre></div><p>修改rdb文件名称</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>dbfilename dump.rdb</span></span></code></pre></div><h3 id="自动保存" tabindex="-1">自动保存 <a class="header-anchor" href="#自动保存" aria-label="Permalink to &quot;自动保存&quot;">​</a></h3><p>配置文件中<strong>SNAPSHOTTING</strong>下修改save</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>将默认注释修改为自定义</span></span>
<span class="line"><span>save 3600 1 300 100 60 10000</span></span></code></pre></div><h3 id="手动保存" tabindex="-1">手动保存 <a class="header-anchor" href="#手动保存" aria-label="Permalink to &quot;手动保存&quot;">​</a></h3><p>save</p><p>会阻塞redis运行<strong>线上禁止使用</strong>,一般使用bgsave命令保存</p><p>bgsave</p><p>可以通过lastsave命令查看最后一次保存时间戳</p><p>可以通过date命令查看具体时间</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">data</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -d</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">时间</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">戳</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span></span></code></pre></div><h2 id="通过rdb文件恢复" tabindex="-1">通过rdb文件恢复 <a class="header-anchor" href="#通过rdb文件恢复" aria-label="Permalink to &quot;通过rdb文件恢复&quot;">​</a></h2><p>将dump.rdb文件移动至redis安装目录重启即可</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>cp /root/redis/dump.rdb  /opt/redis-7.2.3/dump.rdb</span></span></code></pre></div><h2 id="优缺点" tabindex="-1">优缺点 <a class="header-anchor" href="#优缺点" aria-label="Permalink to &quot;优缺点&quot;">​</a></h2><p>单文件表示,适合备份,加载速度快,适合大规模<strong>数据恢复</strong></p><ul><li>服务器意外停止就会丢失最近时间的数据</li><li>内存数据全部同步,数据量太大会影响服务器性能</li><li>依赖于主进程fock,fock时数据会被克隆一份,如果数据量很大,就会影响服务器</li></ul><h2 id="检查修复" tabindex="-1">检查修复 <a class="header-anchor" href="#检查修复" aria-label="Permalink to &quot;检查修复&quot;">​</a></h2><p>使用如下命令(概率修复)</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">redis-check-rdb</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /root/redis/dump.rdb</span></span></code></pre></div><h2 id="禁用" tabindex="-1">禁用 <a class="header-anchor" href="#禁用" aria-label="Permalink to &quot;禁用&quot;">​</a></h2><p>将配置文件save命令注释即可</p><h2 id="优化" tabindex="-1">优化 <a class="header-anchor" href="#优化" aria-label="Permalink to &quot;优化&quot;">​</a></h2><p>bgsave命令出错时是否停止写入默认即可</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>stop-writes-on-bgsave-error yes</span></span></code></pre></div><p>是否压缩存储,会消耗CPU性能,根据具体情况哦配置</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>rdbcompression yes</span></span></code></pre></div><p>是否对快照数据合法校验,也会增加性能消耗,一般为yes(数据重要)</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>rdbchecksum yes</span></span></code></pre></div><p>在主节点上执行BGSAVE或AOF持久化操作时，删除同步锁文件(默认即可)</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>rdb-del-sync-files no</span></span></code></pre></div><h1 id="aof" tabindex="-1">AOF <a class="header-anchor" href="#aof" aria-label="Permalink to &quot;AOF&quot;">​</a></h1><p>以日志形式记录所有写操作,只能读写,不能改</p><p>redis启动时会从头到尾扫描文件构建数据</p><h2 id="开启" tabindex="-1">开启 <a class="header-anchor" href="#开启" aria-label="Permalink to &quot;开启&quot;">​</a></h2><p>aof功能默认不开启如需开启在配置文件配置如下即可</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>appendonly yes</span></span></code></pre></div><h2 id="三种写回策略" tabindex="-1">三种写回策略 <a class="header-anchor" href="#三种写回策略" aria-label="Permalink to &quot;三种写回策略&quot;">​</a></h2><ul><li>everysec(default) 中间方案,先写入缓冲区,每过一秒写入磁盘</li><li>always 每个写命令后立即同步将日志写入磁盘</li><li>no 每个写命令后写入aof文件缓冲区,由操作系统决定何时写入磁盘</li></ul><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>appendfsync everysec</span></span></code></pre></div><h2 id="文件配置" tabindex="-1">文件配置 <a class="header-anchor" href="#文件配置" aria-label="Permalink to &quot;文件配置&quot;">​</a></h2><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>#aof文件路径(在dir配置目录下)</span></span>
<span class="line"><span>#redis7之前和rdb同用一个路径</span></span>
<span class="line"><span>appenddirname &quot;appendonlydir&quot;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>#文件名称</span></span>
<span class="line"><span>appendfilename &quot;appendonly.aof&quot;</span></span></code></pre></div><p>redis7之前aof文件只有一个appendonly.aof</p><p>redis7之后会有如下3种文件</p><ol><li>基本文件 appendonly.aof.1.base.rdb</li><li>增量文件 appendonly.aof.1.incr.aof appendonly.aof.2.incr.aof ...</li><li>清单文件 appendonly.aof.manifest</li></ol><h2 id="错误修复" tabindex="-1">错误修复 <a class="header-anchor" href="#错误修复" aria-label="Permalink to &quot;错误修复&quot;">​</a></h2><p>在appendonlydir目录下执行如下命令</p><p>(--fix不可省略)省略为检查是否有错误</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>redis-check-aof --fix appendonly.aof.1.incr.aof</span></span></code></pre></div><h2 id="优点" tabindex="-1">优点 <a class="header-anchor" href="#优点" aria-label="Permalink to &quot;优点&quot;">​</a></h2><ul><li>aof文件可以轻松修复</li><li>当aof文件很大时,redis会在后台自动重写</li><li>如果不小心删除文件,可以在aof增量文件中删除相应命令重启即可</li></ul><h2 id="缺点" tabindex="-1">缺点 <a class="header-anchor" href="#缺点" aria-label="Permalink to &quot;缺点&quot;">​</a></h2><ul><li>aof文件通常比rdb文件大</li><li>运行效率低于rdb</li></ul><h2 id="重写机制" tabindex="-1">重写机制 <a class="header-anchor" href="#重写机制" aria-label="Permalink to &quot;重写机制&quot;">​</a></h2><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>auto-aof-rewrite-percentage 100</span></span>
<span class="line"><span>auto-aof-rewrite-min-size 64mb</span></span></code></pre></div><p>当满足上述配置文件选项后,redis会自动重写(redis从当前内存中读取数据保存并替换旧的文件)</p><p>也可以手动执行指令触发</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>bgrewriteaof</span></span></code></pre></div><h1 id="混合使用" tabindex="-1">混合使用 <a class="header-anchor" href="#混合使用" aria-label="Permalink to &quot;混合使用&quot;">​</a></h1><p>如果同时开启rdb和aof,启动时只会加载aof文件</p><p>开启混合配置(default)</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>aof-use-rdb-preamble yes</span></span></code></pre></div>`,67)]))}const u=s(t,[["render",p]]);export{b as __pageData,u as default};
